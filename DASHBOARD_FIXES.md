# 🔧 Исправления дашборда

## Проблемы которые были найдены

### 1. ❌ Переменная $array не работала
**Проблема**: В дашборде использовалась переменная `$array`, но в CSV данных используется label `SN` (серийный номер массива).

**Решение**: Заменили `$array` на `$SN` во всех запросах и переменных.

### 2. ❌ Отсутствовала фильтрация по типу ресурса
**Проблема**: В переменной `$Element` были смешаны все элементы всех ресурсов (контроллеры 0A, 0B, LUN, диски, порты).

**Решение**: Добавили переменную `$Resource` для фильтрации по типу ресурса с каскадной фильтрацией.

### 3. ❌ Неправильные названия в заголовках
**Проблема**: В заголовках секций показывалось "Unknown_Controller", "Unknown_LUN" и т.д.

**Решение**: Исправили маппинг ресурсов - теперь используются правильные названия "Controller", "LUN", "Disk" и т.д.

## Что было исправлено

### 1. Переменные дашборда

#### До:
```
$array    - label_values(array)           ❌ Не работало
$Element  - label_values({array=~"$array"},Element)  ❌ Все элементы вперемешку
```

#### После:
```
$SN       - label_values(SN)              ✅ Серийный номер массива
$Resource - label_values({SN=~"$SN"},Resource)  ✅ Тип ресурса
$Element  - label_values({SN=~"$SN", Resource=~"$Resource"},Element)  ✅ Фильтрованные элементы
```

### 2. Запросы в панелях

#### До:
```promql
huawei_kv_cpu_usage_percent{array=~"$array", Resource="207", Element=~"$Element"}
```

#### После:
```promql
huawei_kv_cpu_usage_percent{SN=~"$SN", Resource="Controller", Element=~"$Element"}
```

### 3. Названия ресурсов

#### До:
```python
RESOURCE_MAPPING = {
    "Controller": "Unknown_Controller",  # ❌
    "LUN": "Unknown_LUN",                # ❌
    ...
}
```

#### После:
```python
RESOURCE_MAPPING = {
    "Controller": "Controller",  # ✅
    "LUN": "LUN",                # ✅
    ...
}
```

## Как работает каскадная фильтрация

```
┌─────────────────────────────────────┐
│ 1. Выбираете SN                     │
│    → 2102353TJWFSP3100020           │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 2. Выбираете Resource               │
│    → Controller, LUN, Disk, ...     │
│    (только для выбранного SN)       │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│ 3. Выбираете Element                │
│    Controller → 0A, 0B              │
│    LUN → lun_001, lun_002, ...      │
│    Disk → disk_01, disk_02, ...     │
│    (только для выбранного Resource) │
└─────────────────────────────────────┘
```

## Примеры использования

### Сценарий 1: Показать все данные массива
```
SN: 2102353TJWFSP3100020
Resource: All
Element: All
```
Покажет все графики для всех ресурсов и элементов.

### Сценарий 2: Только контроллеры
```
SN: 2102353TJWFSP3100020
Resource: Controller
Element: All
```
В переменной Element будут только: 0A, 0B
Покажет графики только для контроллеров.

### Сценарий 3: Только один контроллер
```
SN: 2102353TJWFSP3100020
Resource: Controller
Element: 0A
```
Покажет графики только для контроллера 0A.

### Сценарий 4: Все LUN
```
SN: 2102353TJWFSP3100020
Resource: LUN
Element: All
```
Покажет графики для всех LUN массива.

## Проверка исправлений

### 1. Откройте дашборд
http://localhost:3000 → Dashboards → "Huawei OceanStor - Real Data"

### 2. Проверьте переменные в шапке
Должны быть:
- ✅ SN (с описанием "Серийный номер массива")
- ✅ Resource (с описанием "Тип ресурса...")
- ✅ Element (с описанием "Элемент...")

НЕ должно быть:
- ❌ array

### 3. Выберите SN
Выберите: 2102353TJWFSP3100020
- ✅ Должно показать значение в выпадающем списке

### 4. Проверьте Resource
Выберите: Controller
- ✅ В Element должны появиться только: 0A, 0B

Выберите: LUN  
- ✅ В Element должны появиться LUN элементы

### 5. Проверьте заголовки панелей
Разверните секцию "Controller"
- ✅ Заголовки: "CPU Usage (%)", "Cache Hit Ratio (%)" и т.д.
- ❌ НЕ должно быть: "Unknown_Controller"

### 6. Проверьте графики
Выберите Element: 0A
- ✅ Графики должны показывать данные
- ✅ В легенде должно быть: "0A"

## Файлы которые были изменены

1. **build_dashboard_from_real_data.py**
   - Исправлен маппинг ресурсов (убран префикс "Unknown_")

2. **generate_dashboard_fixed.py**
   - Изменен label с `array` на `SN`
   - Обновлены запросы в панелях

3. **generate_dashboard_real.py**
   - Добавлена переменная `$Resource`
   - Настроена каскадная фильтрация
   - Добавлены описания к переменным

4. **resource_metric_mapping_real.py**
   - Исправлены названия ресурсов
   - "Controller" вместо "Unknown_Controller"

5. **grafana/provisioning/dashboards/Huawei-OceanStor-Real-Data.json**
   - Обновлен автоматически генератором

## Следующие шаги

Если в будущем понадобится пересоздать дашборд:

```bash
# 1. Пересоздать маппинг из CSV (если нужно)
python3 build_dashboard_from_real_data.py

# 2. Или просто пересоздать дашборд из существующего маппинга
python3 generate_dashboard_real.py

# 3. Перезапустить Grafana
docker compose restart grafana
```

## Итог

✅ Все проблемы решены:
- Фильтрация по серийному номеру массива работает
- Добавлена фильтрация по типу ресурса
- Каскадная фильтрация элементов
- Правильные названия в заголовках
- 775 панелей с реальными метриками
