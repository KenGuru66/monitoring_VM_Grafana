# docker-compose.yml - универсальная конфигурация (работает везде: WSL, Docker Desktop, Linux)
# Для production с bind mounts к /data/ используйте: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.99.0
    restart: unless-stopped
    ports:
      - "${VM_PORT:-8428}:8428"
    command:
      - --storageDataPath=/vmdata
      - --retentionPeriod=${VM_RETENTION:-6}
      - --maxInsertRequestSize=128MB
      - --maxLabelsPerTimeseries=50
      - -memory.allowedPercent=80
      - -insert.maxQueueDuration=60s
      - -search.maxConcurrentRequests=8
      - -inmemoryDataFlushInterval=5s  # чаще flush (default 1s)
      - -maxConcurrentInserts=32       # больше параллелизма
    volumes:
      - vmdata:/vmdata
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:12.1.1
    user: "472"
    restart: unless-stopped
    depends_on:
      - victoriametrics
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASS:-changeme}
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - monitoring

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      - VM_URL=http://victoriametrics:8428
      - VM_IMPORT_URL=http://victoriametrics:8428/api/v1/import/prometheus
      - GRAFANA_URL=${GRAFANA_URL:-http://localhost:3000}
      - MAX_UPLOAD_SIZE=${MAX_UPLOAD_SIZE:-10737418240}  # 10GB
      - JOB_TIMEOUT=${JOB_TIMEOUT:-86400}  # 24 hours default
      - JOB_TTL_HOURS=${JOB_TTL_HOURS:-24}  # Auto-cleanup after 24 hours
      - WORK_DIR=/app/jobs  # Job output directory
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY:-4}
    volumes:
      - ./uploads:/app/uploads
      - jobs_data:/app/jobs  # Persistent storage for CSV output files
      - ./parsers:/app/parsers  # Все парсеры
      - ./tools:/app/tools  # Утилиты
      - ./perfmonkey:/app/perfmonkey  # Perfmonkey (legacy)
      - ./api:/app/api  # Mount API code for hot-reload
    depends_on:
      - victoriametrics
    networks:
      - monitoring

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:8000}
        - VITE_GRAFANA_URL=${VITE_GRAFANA_URL:-http://localhost:3000}
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3001}:80"
    depends_on:
      - api
    networks:
      - monitoring

  # Perf Watcher - автоматический парсинг Performance Dumps с SFTP
  # Мониторит директорию и обрабатывает новые .tgz файлы
  perf-watcher:
    build:
      context: .
      dockerfile: api/Dockerfile
    command: ["python", "-m", "parsers.perf_watcher"]
    restart: unless-stopped
    environment:
      - VM_URL=http://victoriametrics:8428
      - VM_IMPORT_URL=http://victoriametrics:8428/api/v1/import/prometheus
      - WATCH_DIR=/data/perf-dumps/dumps
      - FILE_WAIT_SECONDS=${FILE_WAIT_SECONDS:-30}
      - DELETE_AFTER_PROCESS=${DELETE_AFTER_PROCESS:-true}
      - BATCH_SIZE=${BATCH_SIZE:-100000}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - POLL_INTERVAL_SECONDS=${POLL_INTERVAL_SECONDS:-60}
    volumes:
      - ./parsers:/app/parsers
      - perf_watcher_logs:/app/logs
      # Для локальной разработки - переопределите в docker-compose.override.yml или prod.yml
      - ${PERF_DUMPS_DIR:-/data/perf-dumps/dumps}:/data/perf-dumps/dumps
    depends_on:
      - victoriametrics
    networks:
      - monitoring

networks:
  monitoring:
    driver: bridge

# Named volumes - данные хранятся в Docker (portable, работает везде)
# Для production с bind mounts используйте docker-compose.prod.yml
volumes:
  vmdata:
  grafana_data:
  jobs_data:
  perf_watcher_logs:
