# üîç –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö API

## üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ #1: DNS Resolution Failure

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
Failed to resolve 'vmagent' ([Errno -3] Temporary failure in name resolution)
HTTPConnectionPool(host='vmagent', port=8429): Max retries exceeded
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä API –Ω–µ —Å–º–æ–≥ —Ä–∞–∑—Ä–µ—à–∏—Ç—å DNS-–∏–º—è `vmagent` –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
  - –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å Docker DNS
  - Vmagent –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –≤–æ –≤—Ä–µ–º—è –∏–º–ø–æ—Ä—Ç–∞
  - –°–µ—Ç–µ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** ‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û**  
‚ùå –î–∞–Ω–Ω—ã–µ –ù–ï –±—ã–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ VictoriaMetrics

**–†–µ—à–µ–Ω–∏–µ:**
‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û** - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (retry):
- 3 –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff (1s, 2s, 4s)
- –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ DNS –æ—à–∏–±–æ–∫
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫

---

### üü° –°—Ä–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞ #2: Corrupted Archive

**–°–æ–æ–±—â–µ–Ω–∏–µ:**
```
Error: Compressed file ended before the end-of-stream marker was reached
[Worker 9359]
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –û–¥–∏–Ω –∏–∑ `.tgz` —Ñ–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –Ω–µ–ø–æ–ª–æ–Ω
- –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
  - –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞
  - –ü—Ä–µ—Ä–≤–∞–Ω–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª–∞
  - –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–∏

**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** ‚ö†Ô∏è **–°–†–ï–î–ù–Ø–Ø**  
‚ö†Ô∏è –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ñ–∞–π–ª –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:**
‚úÖ **–†–ï–ê–õ–ò–ó–û–í–ê–ù–û** - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤:
- Graceful handling –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏
- –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ (EOF, ReadError)
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç—á–µ—Ç–µ

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ –∏–∑ –ª–æ–≥–æ–≤

**–ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫:**
- –û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –æ—à–∏–±–æ–∫ DNS: `01:22:09` - `01:22:17` (~8 —Å–µ–∫—É–Ω–¥)
- –û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞: `02:24:11` (–ø–æ–∑–∂–µ, –¥—Ä—É–≥–∞—è –¥–∂–æ–±–∞)

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:**
- DNS –æ—à–∏–±–∫–∏: ~100+ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç —Ä–∞–∑–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤ (16-42)
- –ê—Ä—Ö–∏–≤–Ω—ã–µ –æ—à–∏–±–∫–∏: 1 —Ñ–∞–π–ª

---

## üõ†Ô∏è –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. Retry Logic –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ VM

**–§—É–Ω–∫—Ü–∏—è:** `send_batch_to_vm()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
- –î–æ–±–∞–≤–ª–µ–Ω–æ 3 –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
- Exponential backoff (1s ‚Üí 2s ‚Üí 4s)
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏
- –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ DNS –æ—à–∏–±–æ–∫
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**  
‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±–æ–∏ DNS –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è

---

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤

**–§—É–Ω–∫—Ü–∏—è:** `decompress_tgz()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
- Try-catch –¥–ª—è tarfile.ReadError, EOFError, OSError
- –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ "unexpected end of file"
- –í–æ–∑–≤—Ä–∞—Ç None –≤–º–µ—Å—Ç–æ –∫—Ä—ç—à–∞
- Graceful skip –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**  
‚úÖ –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è

---

### 3. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–§—É–Ω–∫—Ü–∏—è:** `process_single_tgz_streaming()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
- –°—á–µ—Ç—á–∏–∫ failed_batches
- –ü–æ–¥—Ä–æ–±–Ω—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–∏—á–∏–Ω–∞—Ö –æ—à–∏–±–æ–∫
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**  
‚úÖ –ü–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º –æ—Ç—á–µ—Ç–µ

---

### 4. –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏

**–ü—Ä–∏–º–µ—Ä –Ω–æ–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞:**
```
üìä Results:
   Files processed: 49/50
   ‚ö†Ô∏è  Files failed:  1
   ‚ö†Ô∏è  Corrupted:     1 files
   Metrics sent:    12,345,678
   Batches sent:    247
   ‚ö†Ô∏è  Batches failed: 3
   Total time:      120.5s (2.0 min)
   Throughput:      102,450 metrics/sec
   Array SN:        ABC123
```

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

1. **‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∂–µ –≤–Ω–µ–¥—Ä–µ–Ω–æ** - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ API –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:
   ```bash
   docker-compose restart api
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–¥–æ—Ä–æ–≤—å–µ vmagent:**
   ```bash
   docker ps | grep vmagent
   docker logs monitoring_vm_grafana-vmagent-1 --tail 50
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤—è–∑—å –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏:**
   ```bash
   docker exec monitoring_vm_grafana-api-1 ping -c 3 vmagent
   docker exec monitoring_vm_grafana-api-1 curl http://vmagent:8429/-/healthy
   ```

---

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ vmagent:**
   - –î–æ–±–∞–≤—å—Ç–µ health checks –≤ docker-compose
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ alerts –Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∞—Ä—Ö–∏–≤–æ–≤:**
   - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å `.zip` –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏
   - –î–æ–±–∞–≤—å—Ç–µ MD5/SHA256 checksums

3. **–†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ fallback –Ω–∞ direct VictoriaMetrics (–ø–æ—Ä—Ç 8428)
   - –õ–æ–∫–∞–ª—å–Ω–∞—è –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ VM

---

## üìù –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

| –û—à–∏–±–∫–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –°—Ç–∞—Ç—É—Å | –í–ª–∏—è–Ω–∏–µ |
|--------|-------------|---------|---------|
| DNS Resolution Failure | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö |
| Corrupted Archive | üü° –°—Ä–µ–¥–Ω—è—è | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ | 1 —Ñ–∞–π–ª –ø—Ä–æ–ø—É—â–µ–Ω |

**–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –ü–†–û–ë–õ–ï–ú–´ –£–°–¢–†–ê–ù–ï–ù–´**

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
2. üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ API –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –∏–º–ø–æ—Ä—Ç –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É–ª—É—á—à–µ–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤
4. üîç –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è DNS –ø—Ä–æ–±–ª–µ–º

---

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-10-07  
**–í–µ—Ä—Å–∏—è pipeline:** 2.0.1  
**–°—Ç–∞—Ç—É—Å:** –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–µ–Ω—ã ‚úÖ

