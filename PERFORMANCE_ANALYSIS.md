# üìä –ê–ù–ê–õ–ò–ó –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò STREAMING PIPELINE

## –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

**–§–∞–π–ª:** `/data/perf_logs/Storage_History_Performance_Files(11-24).zip`

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
```
‚úÖ –§–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:    2,584 .tgz —Ñ–∞–π–ª–æ–≤
‚úÖ –ú–µ—Ç—Ä–∏–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:    596,626,023 (596 –º–ª–Ω)
‚úÖ –ë–∞—Ç—á–µ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:    12,910
‚úÖ –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:      449.9 —Å–µ–∫ (7.5 –º–∏–Ω—É—Ç)
‚úÖ Throughput:           1,326,084 metrics/sec (1.3 –º–ª–Ω/—Å–µ–∫)
‚úÖ Workers:              14 (–Ω–∞ 16 vCPU)
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
```
üíæ Memory: 0.03 GB (30 MB)  - –û–¢–õ–ò–ß–ù–û!
üíª CPU:    6.8%             - ‚ö†Ô∏è –û–ß–ï–ù–¨ –ù–ò–ó–ö–û!
üåê Network: ~1.3M metrics/sec
```

## üîç –ê–ù–ê–õ–ò–ó –£–ó–ö–ò–• –ú–ï–°–¢

### 1. ‚ùå CPU –ù–ï —è–≤–ª—è–µ—Ç—Å—è —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º
**–ó–∞–≥—Ä—É–∑–∫–∞ CPU: 6.8% –∏–∑ 100%**

- –ù–∞ 16 vCPU –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ–Ω–µ–µ 7% ‚ö†Ô∏è
- **14 workers –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—Ç 93% –≤—Ä–µ–º–µ–Ω–∏!**
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ vCPU **–ù–ï –î–ê–°–¢** —É—Å–∫–æ—Ä–µ–Ω–∏—è

**–í—ã–≤–æ–¥:** CPU –∏–∑–±—ã—Ç–æ—á–µ–Ω, —É–∑–∫–æ–µ –º–µ—Å—Ç–æ –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ.

### 2. ‚úÖ Memory –æ—Ç–ª–∏—á–Ω–æ
**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: 30 MB**

- Streaming —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ
- –î–∞–∂–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤ 500GB –ø–∞–º—è—Ç–∏ —Ö–≤–∞—Ç–∏—Ç
- Memory **–ù–ï** —É–∑–∫–æ–µ –º–µ—Å—Ç–æ

### 3. üéØ –ì–õ–ê–í–ù–û–ï –£–ó–ö–û–ï –ú–ï–°–¢–û: VictoriaMetrics Write Speed

**–ù–∞–±–ª—é–¥–∞–µ–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å:** 1.3 –º–ª–Ω metrics/sec

–≠—Ç–æ —Ç–∏–ø–∏—á–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ –¥–ª—è VictoriaMetrics —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

#### –ü–æ—á–µ–º—É VM - bottleneck?

1. **HTTP overhead:** –ö–∞–∂–¥—ã–π –±–∞—Ç—á - —ç—Ç–æ HTTP POST –∑–∞–ø—Ä–æ—Å
   - 12,910 –±–∞—Ç—á–µ–π –∑–∞ 450 —Å–µ–∫—É–Ω–¥ = ~29 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫
   - Batch size: 50,000 –º–µ—Ç—Ä–∏–∫

2. **Disk I/O:** VictoriaMetrics –ø–∏—à–µ—Ç –Ω–∞ –¥–∏—Å–∫
   - 596 –º–ª–Ω –º–µ—Ç—Ä–∏–∫ √ó ~150 bytes = ~90 GB –¥–∞–Ω–Ω—ã—Ö
   - –ó–∞ 450 —Å–µ–∫—É–Ω–¥ = ~200 MB/sec –∑–∞–ø–∏—Å—å

3. **Index building:** VM —Å—Ç—Ä–æ–∏—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
   - CPU –≤—Ä–µ–º—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ VM
   - –ù–∞—à–∏ workers –∂–¥—É—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç VM

### 4. üîß –ß—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å?

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 14 Workers  ‚îÇ --> ‚îÇ   Network    ‚îÇ --> ‚îÇ VictoriaMetrics ‚îÇ
‚îÇ (Fast)      ‚îÇ     ‚îÇ   (Fast)     ‚îÇ     ‚îÇ (Bottleneck!)   ‚îÇ
‚îÇ 93% IDLE    ‚îÇ     ‚îÇ              ‚îÇ     ‚îÇ Write: 1.3M/s   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚Üì
                                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                          ‚îÇ   Disk I/O      ‚îÇ
                                          ‚îÇ   Index Build   ‚îÇ
                                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Workers –∂–¥—É—Ç, –ø–æ–∫–∞ VictoriaMetrics –ø—Ä–∏–º–µ—Ç –¥–∞–Ω–Ω—ã–µ!**

## üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### ‚úÖ 1. –£–≤–µ–ª–∏—á–∏—Ç—å Batch Size (–°–ê–ú–û–ï –≠–§–§–ï–ö–¢–ò–í–ù–û–ï)

**–¢–µ–∫—É—â–∏–π:** 50,000 –º–µ—Ç—Ä–∏–∫/–±–∞—Ç—á  
**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π:** 100,000 - 150,000 –º–µ—Ç—Ä–∏–∫/–±–∞—Ç—á

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ú–µ–Ω—å—à–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí –º–µ–Ω—å—à–µ overhead
- –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Ä–∞–∑ ‚Üí —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –¥–ª—è VM
- **–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ: +30-50%**

```bash
python3 huawei_streaming_pipeline.py \
    -i "archive.zip" \
    --batch-size 100000 \
    --vm-url "http://localhost:8428/api/v1/import/prometheus"
```

### ‚úÖ 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å VictoriaMetrics (–í–ê–ñ–ù–û)

–î–æ–±–∞–≤–∏—Ç—å –≤ `docker-compose.yml`:

```yaml
victoriametrics:
  command:
    - --storageDataPath=/vmdata
    - --retentionPeriod=500d
    - --maxInsertRequestSize=128MB      # ‚Üë –£–≤–µ–ª–∏—á–∏—Ç—å –¥–ª—è –±–æ–ª—å—à–∏—Ö –±–∞—Ç—á–µ–π
    - --maxLabelsPerTimeseries=50       # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è Huawei
    - -memory.allowedPercent=80         # 80% RAM –¥–ª—è VM
    - -insert.maxQueueDuration=60s      # ‚Üë –ë–æ–ª—å—à–µ –±—É—Ñ–µ—Ä –¥–ª—è –ø–∏–∫–æ–≤
    - -search.maxConcurrentRequests=8   # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```

**–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ: +20-40%**

### ‚ö†Ô∏è 3. –ù–ï —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å vCPU (–ù–ï –≠–§–§–ï–ö–¢–ò–í–ù–û)

**–ü—Ä–∏—á–∏–Ω–∞:** CPU –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –Ω–∞ 6.8%, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ CPU –Ω–µ –¥–∞—Å—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è.

**–≠–∫–æ–Ω–æ–º–∏—è:**
- –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: 16 vCPU - **–∏–∑–±—ã—Ç–æ—á–Ω–æ**
- **–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è:** 8 vCPU –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
- **–ú–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –≤ 2 —Ä–∞–∑–∞ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏!**

### ‚úÖ 4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å Workers

**–¢–µ–∫—É—â–∏–π:** 14 workers  
**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π:** 8 workers

**–ü—Ä–∏—á–∏–Ω–∞:** –° –±–æ–ª—å—à–∏–º batch size –Ω—É–∂–Ω–æ –º–µ–Ω—å—à–µ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞.

```bash
python3 huawei_streaming_pipeline.py \
    -i "archive.zip" \
    --workers 8 \
    --batch-size 100000
```

### ‚úÖ 5. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSD –¥–ª—è VictoriaMetrics (–ö–†–ò–¢–ò–ß–ù–û)

**–¢–µ–∫—É—â–∏–π –¥–∏—Å–∫:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø `/data/vmdata`

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–∞
df -h /data/vmdata
lsblk -o NAME,TYPE,FSTYPE,SIZE,MOUNTPOINT,MODEL
```

**–ï—Å–ª–∏ HDD ‚Üí –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ NVMe SSD:**
- –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏: HDD ~100-150 MB/s ‚Üí SSD ~500-3000 MB/s
- **–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ: +2-3x**

## üìä –ò–¢–û–ì–û–í–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–±—ã—Å—Ç—Ä–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å)

```bash
# 1. –£–≤–µ–ª–∏—á–∏—Ç—å batch size
--batch-size 100000

# 2. –£–º–µ–Ω—å—à–∏—Ç—å workers
--workers 8
```

**–û–∂–∏–¥–∞–µ–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å:** ~1.8-2.0 –º–ª–Ω metrics/sec (+40%)  
**–í—Ä–µ–º—è –¥–ª—è 500GB/40 –º–ª—Ä–¥:** ~5-6 —á–∞—Å–æ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```yaml
# docker-compose.yml
victoriametrics:
  command:
    - --maxInsertRequestSize=128MB
    - -memory.allowedPercent=80
    - -insert.maxQueueDuration=60s
```

```bash
# –ó–∞–ø—É—Å–∫ pipeline
python3 huawei_streaming_pipeline.py \
    -i "huge_file.zip" \
    --batch-size 100000 \
    --workers 8 \
    --vm-url "http://localhost:8428/api/v1/import/prometheus"
```

**–û–∂–∏–¥–∞–µ–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å:** ~2.2-2.5 –º–ª–Ω metrics/sec (+70-90%)  
**–í—Ä–µ–º—è –¥–ª—è 500GB/40 –º–ª—Ä–¥:** ~4-5 —á–∞—Å–æ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- NVMe SSD –¥–ª—è `/data/vmdata`
- VictoriaMetrics –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤—ã—à–µ)
- Batch size 150,000
- Workers 8

**–û–∂–∏–¥–∞–µ–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å:** ~3.0-3.5 –º–ª–Ω metrics/sec (+130-160%)  
**–í—Ä–µ–º—è –¥–ª—è 500GB/40 –º–ª—Ä–¥:** ~3-3.5 —á–∞—Å–∞

## üéØ –í–´–í–û–î: –ß–¢–û –î–ï–õ–ê–¢–¨?

### ‚ùå –ù–ï –î–ï–õ–ê–¢–¨:
1. ‚ùå **–ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å vCPU** - –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ, CPU –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ 7%
2. ‚ùå –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å workers –≤—ã—à–µ 14 - —Ç–æ–ª—å–∫–æ overhead
3. ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HDD –¥–ª—è VictoriaMetrics - —Å–ª–∏—à–∫–æ–º –º–µ–¥–ª–µ–Ω–Ω–æ

### ‚úÖ –î–ï–õ–ê–¢–¨:
1. ‚úÖ **–£–≤–µ–ª–∏—á–∏—Ç—å batch size –¥–æ 100,000-150,000** (–ø—Ä–æ—Å—Ç–æ–µ, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ)
2. ‚úÖ **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å VictoriaMetrics** (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏)
3. ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSD/NVMe** –¥–ª—è `/data/vmdata` (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
4. ‚úÖ **–£–º–µ–Ω—å—à–∏—Ç—å vCPU –¥–æ 8** - —ç–∫–æ–Ω–æ–º–∏—è –¥–µ–Ω–µ–≥ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏

## üí∞ –≠–ö–û–ù–û–ú–ò–Ø

**–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** 16 vCPU  
**–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è:** 8 vCPU  
**–≠–∫–æ–Ω–æ–º–∏—è:** 50% —Å—Ç–æ–∏–º–æ—Å—Ç–∏ VPS

**–ü—Ä–∏ —ç—Ç–æ–º:**
- –°–∫–æ—Ä–æ—Å—Ç—å —É–≤–µ–ª–∏—á–∏—Ç—Å—è –Ω–∞ 40-90% (–∑–∞ —Å—á–µ—Ç –¥—Ä—É–≥–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π)
- Memory –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 16-32 GB

## üìà –ü–†–û–ì–ù–û–ó –î–õ–Ø –ë–û–õ–¨–®–ò–• –§–ê–ô–õ–û–í

### –î–ª—è 500GB / 40 –º–ª—Ä–¥ —Å—Ç—Ä–æ–∫:

| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | –°–∫–æ—Ä–æ—Å—Ç—å (M/s) | –í—Ä–µ–º—è | vCPU | –°—Ç–æ–∏–º–æ—Å—Ç—å |
|--------------|----------------|-------|------|-----------|
| **–¢–µ–∫—É—â–∞—è**  | 1.3            | ~8.5—á | 16   | $$$       |
| **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è 1** | 1.8-2.0   | ~5-6—á | 8    | $$        |
| **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è 2** | 2.2-2.5   | ~4-5—á | 8    | $$        |
| **–ú–∞–∫—Å–∏–º—É–º** | 3.0-3.5        | ~3-3.5—á | 8  | $$        |

**–ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥:** –£–≤–µ–ª–∏—á–µ–Ω–∏–µ vCPU –ù–ï –Ω—É–∂–Ω–æ, –Ω—É–∂–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è VictoriaMetrics –∏ batch size!

---

**–î–∞—Ç–∞:** 2025-10-07  
**–í–µ—Ä—Å–∏—è:** 1.0
